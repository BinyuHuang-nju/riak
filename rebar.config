%% -*- mode: erlang;erlang-indent-level: 4;indent-tabs-mode: nil -*-
{sub_dirs, ["rel", "apps/riak"]}.

{minimum_otp_vsn, "20.0"}.

{cover_enabled, true}.

{erl_opts, [warnings_as_errors]}.
{eunit_opts, [nowarn_export_all, verbose]}.

{deps, [
        {bitcask, {git, "git://github.com/basho/bitcask.git", {branch, "develop-3.0"}}},
	    {canola, {git, "git://github.com/basho/canola.git", {branch, "develop-3.0"}}},
        {clique, {git, "git://github.com/basho/clique.git", {branch, "develop-3.0"}}},
        {cluster_info, {git, "git://github.com/basho/cluster_info.git", {branch, "develop-3.0"}}},
        {ebloom,{git, "git://github.com/basho/ebloom.git", {branch, "develop-3.0"}}},
        {eleveldb, {git, "git://github.com/basho/eleveldb.git", {branch, "develop-3.0"}}},
        {exometer_core, {git, "git://github.com/Feuerlabs/exometer_core.git", {tag, "v1.5.7"}}},
        {hyper, {git, "git://github.com/basho/hyper", {branch, "develop-3.0"}}},
        {kv_index_tictactree, {git, "https://github.com/martinsumner/kv_index_tictactree.git", {branch, "develop-3.0"}}},
        {lager, {git, "git://github.com/erlang-lager/lager.git", {tag, "3.8.0"}}},
        {lager_syslog, {git, "git://github.com/basho/lager_syslog.git", {branch, "develop-3.0"}}},
        {leveled, {git, "https://github.com/martinsumner/leveled.git", {branch, "develop-3.0"}}},
        {mochiweb, {git, "git://github.com/martinsumner/mochiweb.git", {branch, "develop-3.0"}}},
        {pbkdf2, {git, "git://github.com/basho/erlang-pbkdf2.git", {branch, "develop-3.0"}}},
        {poolboy, {git, "https://github.com/basho/poolboy.git", {branch, "develop-3.0"}}},
        {ranch, {git, "git://github.com/ninenines/ranch.git", {tag, "1.6.0"}}},
        {recon, {git, "https://github.com/ferd/recon", {tag, "2.4.0"}}},
        {redbug, {git, "https://github.com/massemanet/redbug", {tag, "1.2.1"}}},
        {riak_pb, {git, "git://github.com/basho/riak_pb.git", {tag, "develop-3.0"}}},
        {sext, {git, "git://github.com/uwiger/sext.git", {tag, "1.4.1"}}},
        {sidejob, {git, "git://github.com/basho/sidejob.git", {branch, "develop-3.0"}}},
        {webmachine, {git, "git://github.com/webmachine/webmachine.git", {tag, "1.11.1"}}}
        % {yokozuna, {git, "git://github.com/basho/yokozuna.git", {branch, "develop-3.0"}}}
      ]}.

{project_plugins, [
    {rebar3_cuttlefish, {git, "https://github.com/basho/rebar3_cuttlefish", {branch, "develop-3.0"}}}
]}.

{plugins, [rebar3_gpb_plugin,
           {eqc_rebar, {git, "https://github.com/Quviq/eqc-rebar", {branch, "master"}}}]}.

{cuttlefish, [
    {file_name, "riak.conf"},
    {disable_bin_scripts, true},
    {schema_discovery, true},
    {schema_order, [
        riak,
        erlang_vm,
        riak_core,
        riak_api,
        riak_kv,
        riak_sysmon,
        bitcask,
        bitcask_multi,
        eleveldb,
        eleveldb_multi,
        leveled,
        leveled_multi,
        multi_backend,
        riak_repl
    ]}
]}.

{relx, [{release, {riak, "3.0"},
    [kernel,
     stdlib,
     lager,
     lager_syslog,
     sasl,
     public_key,
     ssl,
     exometer_core,
     riak_sysmon,
     os_mon,
     crypto,
     runtime_tools,
     xmerl,
     mochiweb,
     webmachine,
     bitcask,
     basho_stats,
     clique,
     riak_pb,
     riak_core,
     riak_pipe,
     riak_kv,
     riak_api,
     riak_repl,
     cluster_info,
     % yokozuna,
     riak_auth_mods]},

    {dev_mode, false},
    {include_erts, true},

    {overlay, [
         {mkdir, "lib/patches"},
         {mkdir, "data/ring"},

         {template, "rel/files/advanced.config", "etc/advanced.config"},

         %% Copy additional bin scripts
         {template, "rel/files/riak-admin",        "bin/riak-admin"},
         {template, "rel/files/riak-debug",        "bin/riak-debug"},
         {template, "rel/files/riak-chkconfig",    "bin/riak-chkconfig"},
         {template, "rel/files/riak-repl",         "bin/riak-repl"},

         {template, "rel/files/riak",               "usr/bin/riak"},

         {copy, "rel/files/check_ulimit", "bin/hooks/check_ulimit"},
         {copy, "rel/files/riak_not_running", "bin/hooks/riak_not_running"}

    ]},

    {generate_start_script, true},
    {extended_start_script, true},
    {extended_start_script_extensions, [
        {admin, "riak-admin"},
        {debug, "riak-debug"},
        {repl, "riak-repl"},
        {chkconfig, "riak-chkconfig"}
    ]}

]}.

{dialyzer, [{plt_apps, all_deps}]}.

{profiles, [
    {rel, [
        {relx, [
            {overlay_vars, "rel/vars.config"},
            {extended_start_script_hooks,
                [{pre_start,
                    [{custom, "hooks/riak_not_running"},
                    {custom, "hooks/check_ulimit"}]},
                {post_start,
                [{wait_for_process, riak_core_node_watcher}]}
                ]}
        ]}
    ]},
    {dev, [{relx, [
            {dev_mode, true},
            {extended_start_script_hooks,
                    [{pre_start,
                        [{custom, "hooks/riak_not_running"},
                        {custom, "hooks/check_ulimit"}]},
                    {post_start,
                        [{wait_for_process, riak_core_node_watcher}]}
                    ]}
        ]}
    ]},
    {rpm, [
        {relx, [
            {overlay_vars, "rel/pkg/rpm/vars.config"},
            {overlay, [
                {template, "rel/files/riak", "usr/bin/riak"},
                {template, "rel/pkg/rpm/init.script", "etc/init.d/init.script"}
            ]},
            {extended_start_script_hooks,
                    [{pre_start,
                        [{custom, "hooks/riak_not_running"},
                        {custom, "hooks/check_ulimit"}]},
                    {post_start,
                        [{pid, "/run/riak/riak.pid"},
                        {wait_for_process, riak_core_node_watcher}]}
                    ]}
        ]}
    ]},
    {deb, [
        {relx, [
            {overlay_vars, "debian/vars.config"},
            {overlay, [
                {template, "rel/files/riak", "usr/bin/riak"}
            ]},
            {extended_start_script_hooks,
                    [{pre_start,
                        [{custom, "hooks/riak_not_running"},
                        {custom, "hooks/check_ulimit"}]},
                    {post_start,
                        [wait_for_vm_start,
                            {pid, "/run/riak/riak.pid"},
                            {wait_for_process, riak_core_node_watcher}]}
                    ]}
        ]}
    ]}
]}.
